name: Deploy to VPS (SSH)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      path:
        description: "Remote path"
        required: true
        default: "/var/www/ecom"
      allow_mutating_smokes:
        description: "Run data-mutating smokes (create vendor/user/category)"
        required: false
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install pnpm
        run: corepack enable && corepack prepare pnpm@8.6.10 --activate
      - name: Pre-deploy build verification
        run: |
          set -e
          pnpm install -r --no-frozen-lockfile
          pnpm --filter @repo/db build
          pnpm --filter @repo/api clean
          pnpm --filter @repo/api exec tsc -p tsconfig.json
          pnpm --filter admin build

      # E2E auth moved to dedicated workflow
      - name: Archive project (use git archive to avoid file change warnings)
        run: |
          git config --global core.autocrlf false
          git archive --format=tar.gz -o app.tar.gz HEAD

      - name: Set SSH connection env (with safe defaults)
        shell: bash
        env:
          VPS_HOST: ${{ secrets.VPS_HOST || vars.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER || vars.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT || vars.VPS_PORT }}
        run: |
          set -e
          if [ -z "${VPS_HOST}" ]; then
            echo 'ERROR: VPS_HOST is not set in secrets/vars.'
            echo 'Dumping current env values for diagnostics:'
            echo "VPS_HOST='${VPS_HOST}' VPS_PORT='${VPS_PORT}' VPS_USER='${VPS_USER}'"
            echo 'Ensure these are set under Settings → Secrets and variables → Actions (Repository level).'
            exit 1
          fi
          echo "SSH_HOST=${VPS_HOST}" >> "$GITHUB_ENV"
          echo "SSH_USER=${VPS_USER:-root}" >> "$GITHUB_ENV"
          echo "SSH_PORT=${VPS_PORT:-22}" >> "$GITHUB_ENV"
      - name: Normalize SSH key to file (for appleboy actions)
        shell: bash
        run: |
          set -e
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            mkdir -p "$GITHUB_WORKSPACE/.ssh"
            umask 177
            KEY_CONTENT="${{ secrets.SSH_PRIVATE_KEY }}"
            if printf '%s' "$KEY_CONTENT" | grep -q '\\n'; then KEY_CONTENT=$(printf '%s' "$KEY_CONTENT" | sed 's/\\r//g; s/\\n/\n/g'); fi
            printf '%s' "$KEY_CONTENT" | tr -d '\r' > "$GITHUB_WORKSPACE/.ssh/deploy_key"
            # appleboy container may run as a different user; allow read access
            chmod 755 "$GITHUB_WORKSPACE/.ssh"
            chmod 644 "$GITHUB_WORKSPACE/.ssh/deploy_key"
            echo "SSH_KEY_PATH=$GITHUB_WORKSPACE/.ssh/deploy_key" >> "$GITHUB_ENV"
            echo "HAVE_SSH=1" >> "$GITHUB_ENV"
          fi
      - name: Write SSH key for preflight (if provided)
        shell: bash
        run: |
          set -e
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            mkdir -p ~/.ssh
            umask 177
            printf "%s\n" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
            chmod 600 ~/.ssh/deploy_key
          else
            echo 'No SSH_PRIVATE_KEY secret provided; skipping handshake preflight'
          fi
      - name: Set admin credentials env
        run: |
          echo "ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}" >> "$GITHUB_ENV"
          echo "ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}" >> "$GITHUB_ENV"

      - name: Check SSH reachability (preflight with retries and handshake)
        if: ${{ env.HAVE_SSH == '1' }}
        shell: bash
        run: |
          set -e
          echo "Host: ${SSH_HOST} Port: ${SSH_PORT} User: ${SSH_USER}"
          echo 'DNS resolution:'
          getent hosts "${SSH_HOST}" || true
          CANDIDATE_PORTS="${SSH_PORT} 22 2222 443"
          SELECTED_PORT=""
          for p in $CANDIDATE_PORTS; do
            echo "== Probing TCP ${SSH_HOST}:$p =="
            ok=0
            for i in $(seq 1 10); do
              nc -z -w5 "${SSH_HOST}" "$p" && { ok=1; break; } || true
              sleep 2
            done
            if [ "$ok" = "1" ]; then
              echo "TCP reachable on port $p"; SELECTED_PORT="$p"; break
            fi
          done
          if [ -z "$SELECTED_PORT" ]; then
            echo 'WARN: No reachable SSH TCP port found. Skipping SSH-based deploy steps.'
            ip route || true
            echo "HAVE_SSH=0" >> "$GITHUB_ENV"
            echo "SELECTED_SSH_PORT=0" >> "$GITHUB_ENV"
            exit 0
          fi
          echo "SELECTED_SSH_PORT=$SELECTED_PORT" >> "$GITHUB_ENV"
          if [ -f ~/.ssh/deploy_key ]; then
            echo "Attempting SSH handshake to ${SSH_USER}@${SSH_HOST}:$SELECTED_PORT ..."
            tries=0
            until ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=8 -p "$SELECTED_PORT" "$SSH_USER@$SSH_HOST" 'echo ok' ; do
              tries=$((tries+1))
              if [ $tries -ge 5 ]; then
                echo 'WARN: SSH handshake failed after retries. Skipping SSH-based deploy steps.'
                echo "HAVE_SSH=0" >> "$GITHUB_ENV"
                exit 0
              fi
              sleep 3
            done
          fi

      - name: Bootstrap Node 20 + pnpm on VPS (if missing)
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY && '' }}
          password: ${{ secrets.SSH_PASSWORD && '' }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT }}
          timeout: 180s
          command_timeout: 10m
          debug: true
          script_stop: true
          script: |
            set -euxo pipefail
            if ! command -v node >/dev/null 2>&1; then
              echo "[bootstrap] Installing Node.js 20.x"
              export DEBIAN_FRONTEND=noninteractive
              apt-get update -y
              apt-get install -y curl ca-certificates gnupg
              curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
              apt-get install -y nodejs
            fi
            if ! command -v corepack >/dev/null 2>&1; then
              echo "[bootstrap] Corepack not found; attempting to enable via npm (Node 20 usually ships with corepack)"
              npm i -g corepack || true
            fi
            corepack enable || true
            corepack prepare pnpm@8.6.10 --activate || true
            if ! command -v pnpm >/dev/null 2>&1; then
              echo "[bootstrap] pnpm still not found; installing via npm as fallback"
              npm i -g pnpm@8 || true
            fi
            echo "[bootstrap] node: $(node -v || true), pnpm: $(pnpm -v || true)"

      - name: Prepare API env file on server
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY && '' }}
          password: ${{ secrets.SSH_PASSWORD && '' }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT }}
          timeout: 180s
          command_timeout: 15m
          debug: true
          script_stop: true
          script: |
            set -ex
            ROOT=${{ github.event.inputs.path || '/var/www/ecom' }}
            mkdir -p "$ROOT"
            F="$ROOT/.env.api"
            API_BASE_VAL='${{ secrets.PUBLIC_API_BASE || secrets.NEXT_PUBLIC_API_BASE_URL || 'https://api.jeeey.com' }}'
            MWEB_BASE_VAL='${{ secrets.MWEB_BASE_URL || secrets.NEXT_PUBLIC_MWEB_URL || secrets.NEXT_PUBLIC_APP_URL || 'https://m.jeeey.com' }}'
            {
              echo "NODE_ENV=production"
              echo "COOKIE_DOMAIN=${{ secrets.COOKIE_DOMAIN || vars.COOKIE_DOMAIN }}"
              echo "PUBLIC_API_BASE=$API_BASE_VAL"
              echo "MWEB_BASE_URL=$MWEB_BASE_VAL"
              echo "DEFAULT_COUNTRY_CODE=${{ secrets.DEFAULT_COUNTRY_CODE || vars.DEFAULT_COUNTRY_CODE || '+967' }}"
              echo "CORS_ALLOW_ORIGINS=${{ secrets.CORS_ALLOW_ORIGINS || vars.CORS_ALLOW_ORIGINS }}"
              echo "NEXT_PUBLIC_ADMIN_URL=${{ secrets.NEXT_PUBLIC_ADMIN_URL || vars.NEXT_PUBLIC_ADMIN_URL }}"
              echo "NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL || vars.NEXT_PUBLIC_APP_URL }}"
              echo "JWT_SECRET=${{ secrets.JWT_SECRET }}"
              echo "JWT_SECRET_FALLBACKS=${{ secrets.JWT_SECRET_FALLBACKS || '' }}"
              echo "MAINTENANCE_SECRET=${{ secrets.MAINTENANCE_SECRET }}"
              echo "SENTRY_DSN=${{ secrets.SENTRY_DSN }}"
              echo "STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}"
              echo "STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}"
              echo "CLOUDINARY_URL=${{ secrets.CLOUDINARY_URL }}"
              echo "DEEPSEEK_API_KEY=${{ secrets.DEEPSEEK_API_KEY }}"
              echo "DEEPSEEK_MODEL=${{ secrets.DEEPSEEK_MODEL }}"
              echo "DATABASE_URL=${{ secrets.DATABASE_URL }}"
              echo "DIRECT_URL=${{ secrets.DIRECT_URL }}"
              echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}"
              echo "GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}"
              echo "GOOGLE_REDIRECT_URI=${{ secrets.GOOGLE_REDIRECT_URI }}"
              echo "WHATSAPP_TOKEN=${{ secrets.WHATSAPP_TOKEN }}"
              echo "WHATSAPP_PHONE_ID=${{ secrets.WHATSAPP_PHONE_ID }}"
              echo "WHATSAPP_BUSINESS_ACCOUNT_ID=${{ secrets.WHATSAPP_BUSINESS_ACCOUNT_ID }}"
              echo "WHATSAPP_TEMPLATE=${{ secrets.WHATSAPP_TEMPLATE }}"
              echo "WHATSAPP_LANGUAGE=${{ secrets.WHATSAPP_LANGUAGE }}"
              echo "WHATSAPP_HEADER_TYPE=${{ secrets.WHATSAPP_HEADER_TYPE }}"
              echo "WHATSAPP_HEADER_PARAM=${{ secrets.WHATSAPP_HEADER_PARAM }}"
              echo "WHATSAPP_BUTTON_TYPE=${{ secrets.WHATSAPP_BUTTON_TYPE }}"
              echo "WHATSAPP_BUTTON_INDEX=${{ secrets.WHATSAPP_BUTTON_INDEX }}"
              echo "WHATSAPP_BUTTON_PARAM=${{ secrets.WHATSAPP_BUTTON_PARAM }}"
              echo "WA_OTP_STRICT=${{ secrets.WA_OTP_STRICT || vars.WA_OTP_STRICT || '1' }}"
              echo "OTP_SMS_WITH_WA=${{ secrets.OTP_SMS_WITH_WA || vars.OTP_SMS_WITH_WA || '1' }}"
              echo "TWILIO_ACCOUNT_SID=${{ secrets.TWILIO_ACCOUNT_SID }}"
              echo "TWILIO_AUTH_TOKEN=${{ secrets.TWILIO_AUTH_TOKEN }}"
              echo "TWILIO_SMS_FROM=${{ secrets.TWILIO_SMS_FROM }}"
              echo "VONAGE_API_KEY=${{ secrets.VONAGE_API_KEY }}"
              echo "VONAGE_API_SECRET=${{ secrets.VONAGE_API_SECRET }}"
              echo "VONAGE_FROM=${{ secrets.VONAGE_FROM }}"
            } > "$F.new"
            mv "$F.new" "$F"
            chmod 600 "$F"

      - name: Prepare WEB env file on server
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT }}
          timeout: 180s
          command_timeout: 15m
          debug: true
          script_stop: true
          script: |
            set -ex
            ROOT=${{ github.event.inputs.path || '/var/www/ecom' }}
            F="$ROOT/.env.web"
            {
              echo "NEXT_PUBLIC_APP_URL=${{ secrets.NEXT_PUBLIC_APP_URL || vars.NEXT_PUBLIC_APP_URL }}"
              echo "NEXT_PUBLIC_ADMIN_URL=${{ secrets.NEXT_PUBLIC_ADMIN_URL || vars.NEXT_PUBLIC_ADMIN_URL }}"
              echo "NEXT_PUBLIC_API_BASE_URL=${{ secrets.NEXT_PUBLIC_API_BASE_URL || vars.NEXT_PUBLIC_API_BASE_URL }}"
              echo "NEXT_PUBLIC_TRPC_URL=${{ secrets.NEXT_PUBLIC_TRPC_URL || vars.NEXT_PUBLIC_TRPC_URL }}"
              echo "VITE_API_BASE=${{ secrets.NEXT_PUBLIC_API_BASE_URL || vars.NEXT_PUBLIC_API_BASE_URL }}"
            } > "$F.new"
            mv "$F.new" "$F"
            chmod 600 "$F"

      - name: Copy to server
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT }}
          timeout: 180s
          source: "app.tar.gz"
          target: ${{ github.event.inputs.path || '/var/www/ecom' }}
          overwrite: true

      - name: Remote deploy (clean rebuild)
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT }}
          timeout: 240s
          command_timeout: 20m
          debug: true
          script_stop: true
          script: |
            set -ex
            PATH_ON_HOST=${{ github.event.inputs.path || '/var/www/ecom' }}
            mkdir -p "$PATH_ON_HOST"
            tar -xzf "$PATH_ON_HOST/app.tar.gz" -C "$PATH_ON_HOST"
            cd "$PATH_ON_HOST"
            export ADMIN_EMAIL="${ADMIN_EMAIL:-admin@example.com}"
            export ADMIN_PASSWORD="${ADMIN_PASSWORD:-admin123}"
            # Clean old dist on server before deploy script to ensure fresh build
            rm -rf "$PATH_ON_HOST/packages/api/dist" || true
            pnpm install --frozen-lockfile=false
            bash infra/scripts/deploy.sh "$PATH_ON_HOST"
            echo '--- Prisma migrate (deploy) ---'
            if [ -f "$PATH_ON_HOST/.env.api" ]; then
              set -a
              . "$PATH_ON_HOST/.env.api"
              set +a
            fi
            if [ -n "${DATABASE_URL:-}" ] && [ -n "${DIRECT_URL:-}" ]; then
              echo "Running prisma migrate deploy with DATABASE_URL=$DATABASE_URL"
              cd "$PATH_ON_HOST/packages/db"
              pnpm install --prod --ignore-scripts || true
              npx prisma migrate deploy || pnpm prisma migrate deploy || true
              cd "$PATH_ON_HOST"
            else
              echo 'DATABASE_URL/DIRECT_URL not set; skipping prisma migrate deploy'
            fi
            echo '--- Install Nginx config (jeeey.conf) ---'
            if [ -f infra/nginx/jeeey.conf.tpl ]; then
              # Write template verbatim (no sed template variables like domain_web)
              TMP="/tmp/jeeey.conf.$$"
              cat infra/nginx/jeeey.conf.tpl > "$TMP"
              TARGET="/etc/nginx/sites-available/jeeey.conf"
              mv "$TMP" "$TARGET"
              ln -sf "$TARGET" /etc/nginx/sites-enabled/jeeey.conf
              # Ensure ACME webroot and remove duplicate/default confs to avoid conflicts
              mkdir -p /var/www/letsencrypt || true
              rm -f /etc/nginx/conf.d/jeeey.conf /etc/nginx/conf.d/default.conf /etc/nginx/sites-enabled/default || true
              # Remove any old jeeey-ssl.conf (and backups) from sites-enabled before validation
              rm -f /etc/nginx/sites-enabled/jeeey-ssl.conf /etc/nginx/sites-enabled/jeeey-ssl.conf.* 2>/dev/null || true
              # Remove any other 443 server files except jeeey.conf (HTTP-only template)
              for f in /etc/nginx/sites-enabled/*; do [ -f "$f" ] || continue; base=$(basename "$f"); if [ "$base" != "jeeey.conf" ] && [ "$base" != "jeeey-ssl.conf" ] && grep -q "listen 443" "$f" 2>/dev/null; then rm -f "$f"; fi; done
              # Write CORS map at http-level so ensure-https can rely on it
              printf '%s\n' \
                'map $http_origin $cors_allow_origin {' \
                '    default "";' \
                '    ~^https://(m\.jeeey\.com|admin\.jeeey\.com|jeeey\.com|www\.jeeey\.com)$ $http_origin;' \
                '}' > /etc/nginx/conf.d/cors_map.conf
              echo 'Validating nginx config (staging only, no reload yet)...'
              nginx -t || true
              echo 'Nginx config staged; reload will occur after ensure-https.'
            fi
            echo '--- Ensure HTTPS (certbot if configured) ---'
            CERT_EMAIL='${{ secrets.CERTBOT_EMAIL || vars.CERTBOT_EMAIL }}'
            # Always run ensure-https.sh; it will skip issuance if CERTBOT_EMAIL is empty but still write SSL config
            ( set +e; CERTBOT_EMAIL="$CERT_EMAIL" PROJECT_DIR="$ROOT" bash "$ROOT/infra/deploy/ensure-https.sh"; set -e )

      - name: Force-enable SSL and verify 443 (post ensure-https)
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT }}
          timeout: 120s
          command_timeout: 10m
          script_stop: true
          script: |
            set -e
            echo '--- Rewrite jeeey-ssl.conf explicitly (no inline map) ---'
            rm -f /etc/nginx/sites-enabled/jeeey-ssl.conf /etc/nginx/sites-enabled/jeeey-ssl.conf.* || true
            printf '%s\n' \
              'server {' \
              '  listen 443 ssl http2; listen [::]:443 ssl http2;' \
              '  server_name api.jeeey.com;' \
              '  ssl_certificate /etc/letsencrypt/live/api.jeeey.com/fullchain.pem;' \
              '  ssl_certificate_key /etc/letsencrypt/live/api.jeeey.com/privkey.pem;' \
              '  include /etc/letsencrypt/options-ssl-nginx.conf; ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;' \
              '  location /socket.io/ {' \
              '    proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade;' \
              '    proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme;' \
              '    proxy_read_timeout 70s; proxy_send_timeout 70s; proxy_buffering off; proxy_pass http://127.0.0.1:4000;' \
              '  }' \
              '  # Serve local uploads saved by API' \
              '  location /uploads/ {' \
              '    alias /var/www/ecom/uploads/;' \
              '    add_header Cache-Control "public, max-age=60" always;' \
              '    try_files $uri =404;' \
              '  }' \
              '  location / {' \
              '    proxy_pass http://127.0.0.1:4000; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme;' \
              '  }' \
              '}' \
              'server {' \
              '  listen 443 ssl http2; listen [::]:443 ssl http2;' \
              '  server_name admin.jeeey.com;' \
              '  ssl_certificate /etc/letsencrypt/live/admin.jeeey.com/fullchain.pem;' \
              '  ssl_certificate_key /etc/letsencrypt/live/admin.jeeey.com/privkey.pem;' \
              '  include /etc/letsencrypt/options-ssl-nginx.conf; ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;' \
              '  location / {' \
              '    proxy_pass http://127.0.0.1:3001; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme;' \
              '    proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade; add_header Cache-Control "no-store" always;' \
              '  }' \
              '}' \
              'server {' \
              '  listen 443 ssl http2; listen [::]:443 ssl http2;' \
              '  server_name jeeey.com www.jeeey.com;' \
              '  ssl_certificate /etc/letsencrypt/live/jeeey.com/fullchain.pem;' \
              '  ssl_certificate_key /etc/letsencrypt/live/jeeey.com/privkey.pem;' \
              '  include /etc/letsencrypt/options-ssl-nginx.conf; ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;' \
              '  location / {' \
              '    proxy_pass http://127.0.0.1:3000; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme;' \
              '    proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection $connection_upgrade;' \
              '  }' \
              '}' \
              'server {' \
              '  listen 443 ssl http2; listen [::]:443 ssl http2;' \
              '  server_name m.jeeey.com;' \
              '  ssl_certificate /etc/letsencrypt/live/m.jeeey.com/fullchain.pem;' \
              '  ssl_certificate_key /etc/letsencrypt/live/m.jeeey.com/privkey.pem;' \
              '  include /etc/letsencrypt/options-ssl-nginx.conf; ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;' \
              '  root /var/www/ecom/apps/mweb/dist; index index.html;' \
              '  add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;' \
              '  add_header X-Robots-Tag "noindex, nofollow" always;' \
              '  location /assets/ { add_header Cache-Control "public, max-age=60, must-revalidate" always; try_files $uri $uri/ =404; }' \
              '  location / { add_header Cache-Control "no-store" always; try_files $uri $uri/ /index.html; }' \
              '}' \
              > /etc/nginx/sites-available/jeeey-ssl.conf
            ln -sf /etc/nginx/sites-available/jeeey-ssl.conf /etc/nginx/sites-enabled/jeeey-ssl.conf
            echo '--- Reload nginx ---'
            nginx -t && (nginx -s reload || systemctl reload nginx || systemctl restart nginx) || (journalctl -u nginx -n 100 --no-pager || true; exit 1)
            echo '--- Wait for 443 readiness ---'
            ok=0; for i in $(seq 1 30); do code=$(curl -ksS -o /dev/null -w '%{http_code}' https://api.jeeey.com/health || true); echo "try $i => $code"; [ "$code" = "200" ] && ok=1 && break; sleep 2; done; [ "$ok" = "1" ] || exit 1

      - name: Post-deploy smoke (health, login, static, services)
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT }}
          timeout: 240s
          command_timeout: 20m
          debug: true
          script_stop: true
          script: |
            set -Eeuxo pipefail
            ROOT="${{ github.event.inputs.path || '/var/www/ecom' }}"
            echo '--- Restart API service and wait health (4000) ---'
            systemctl reset-failed ecom-api || true
            systemctl restart ecom-api || true
            okapi=0
            for i in $(seq 1 60); do
              code=$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:4000/health || true)
              if [ "$code" = "200" ]; then echo "api local ok: $code"; okapi=1; break; fi
              sleep 2
            done
            if [ "$okapi" != "1" ]; then
              echo 'API did not become ready locally. Recent logs:'
              journalctl -u ecom-api --no-pager -n 200 || true
              exit 1
            fi
            echo '--- Restart admin service to load latest build ---'
            systemctl reset-failed ecom-admin || true
            systemctl try-restart ecom-admin || true
            echo '--- Wait for admin to serve /login on 3001 (local) ---'
            ok=0
            for i in $(seq 1 40); do
              code=$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:3001/login || true)
              if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ] || [ "$code" = "307" ] || [ "$code" = "308" ]; then
                echo "admin local ok: $code"; ok=1; break
              fi
              sleep 1
            done
            if [ "$ok" != "1" ]; then
              echo 'Admin did not become ready locally. Recent logs:'
              journalctl -u ecom-admin --no-pager -n 200 || true
              exit 1
            fi
            echo '--- Copying standalone assets for admin ---'
            if [ -d "$ROOT/apps/admin/.next/standalone" ]; then
              cp -r "$ROOT/apps/admin/public" "$ROOT/apps/admin/.next/standalone/"
              if [ -d "$ROOT/apps/admin/.next/static" ]; then
                cp -r "$ROOT/apps/admin/.next/static" "$ROOT/apps/admin/.next/standalone/.next/"
              fi
            fi
            echo '--- Verify static chunk is served by app ---'
            CHUNK=$(find "$ROOT/apps/admin/.next/static" -type f -name '*.js' -printf '%P\n' | head -n1 || true)
            if [ -n "$CHUNK" ]; then
              code=$(curl -s -o /dev/null -w '%{http_code}' "http://127.0.0.1:3001/_next/static/$CHUNK" || true)
              echo "static chunk status: $code"
              [ "$code" = "200" ] || { echo "Static chunk not served"; exit 1; }
            else
              echo 'No static chunks found locally'; exit 1
            fi
            echo '--- Verify deepseek dist has no default fallback string ---'
            if [ -d "$ROOT/packages/api/dist" ]; then
              MATCH=$(grep -R -nE "\|\|\s*['\"]فستان['\"]" "$ROOT/packages/api/dist" 2>/dev/null | head -n1 || true)
              if [ -z "$MATCH" ]; then
                echo 'Deepseek dist OK (no default name assignment).'
              else
                echo 'Deepseek dist still contains a default assignment to ("فستان").'
                echo "$MATCH"
                exit 1
              fi
            else
              echo 'packages/api/dist missing; build may have failed.'
              exit 1
            fi
            echo '--- Restart web service to load latest build ---'
            systemctl reset-failed ecom-web || true
            systemctl try-restart ecom-web || true
            echo '--- Wait for web to listen on 3000 (local) ---'
            okw=0
            for i in $(seq 1 60); do
              code=$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:3000/ || true)
              if [ "$code" = "200" ] || [ "$code" = "301" ] || [ "$code" = "302" ] || [ "$code" = "307" ] || [ "$code" = "308" ]; then
                echo "web local ok: $code"; okw=1; break
              fi
              sleep 1
            done
            if [ "$okw" != "1" ]; then
              echo 'Web did not become ready locally. Recent logs:'
              journalctl -u ecom-web --no-pager -n 200 || true
              exit 1
            fi
            echo '--- Nginx config test ---'
            nginx -t
            echo '--- Services status ---'
            for s in ecom-api ecom-admin ecom-web; do systemctl is-active --quiet "$s" && echo "$s: active" || (echo "$s: inactive"; true); done
            echo '--- Health checks (local) ---'
            curl -fsS http://127.0.0.1:4000/health | head -n1 || true
            echo '--- Ensure admin exists & JSON login (local API) ---'
            set +e
            if [ -f "$ROOT/.env.api" ]; then
              EMAIL="${ADMIN_EMAIL:-admin@example.com}"
              PASS="${ADMIN_PASSWORD:-admin123}"
              JSON_STATUS=$(curl -s -o /dev/null -w '%{http_code}' -X POST http://127.0.0.1:4000/api/admin/auth/login -H 'content-type: application/json' --data "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"remember\":true}")
              if [ "$JSON_STATUS" != "200" ]; then
                . "$ROOT/.env.api" || true
                curl -s -X POST http://127.0.0.1:4000/api/admin/maintenance/create-admin -H "x-maintenance-secret: ${MAINTENANCE_SECRET:-}" -H 'content-type: application/json' --data "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"name\":\"Admin\"}" || true
                sleep 1
                JSON_STATUS=$(curl -s -o /dev/null -w '%{http_code}' -X POST http://127.0.0.1:4000/api/admin/auth/login -H 'content-type: application/json' --data "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"remember\":true}")
                echo "json status (retry): $JSON_STATUS"
                if [ "$JSON_STATUS" != "200" ]; then
                  echo 'Admin login failed after bootstrap'
                  journalctl -u ecom-api --no-pager -n 200 || true
                  exit 1
                fi
              fi
              # Verify whoami with cookie jar
              curl -c /tmp/c.jar -s -o /dev/null -w '%{http_code}\n' -X POST http://127.0.0.1:4000/api/admin/auth/login -H 'content-type: application/json' --data "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"remember\":true}" | grep -q 200
              WHO=$(curl -b /tmp/c.jar -s http://127.0.0.1:4000/api/admin/auth/whoami || true)
              echo "whoami: $WHO"
              echo "$WHO" | grep -q '"authenticated":true' || { echo 'whoami did not authenticate'; exit 1; }
            else
              echo '.env.api missing; skipping login.'
            fi
            set -e
      - name: Post-deploy ensure RBAC and admin (always)
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT }}
          timeout: 180s
          command_timeout: 10m
          debug: true
          script_stop: true
          script: |
            set -Eeuxo pipefail
            ROOT=${{ github.event.inputs.path || '/var/www/ecom' }}
            EMAIL=${ADMIN_EMAIL:-${{ secrets.ADMIN_EMAIL || 'admin@example.com' }}}
            PASS=${ADMIN_PASSWORD:-${{ secrets.ADMIN_PASSWORD || 'admin123' }}}
            API=http://127.0.0.1:4000
            if [ -f "$ROOT/.env.api" ]; then . "$ROOT/.env.api" || true; fi
            echo '--- ensure RBAC'
            curl -sS -H "x-maintenance-secret: ${MAINTENANCE_SECRET:-}" -X POST "$API/api/admin/maintenance/ensure-rbac" | sed -n '1,60p' || true
            echo '--- create admin (idempotent)'
            curl -sS -H "x-maintenance-secret: ${MAINTENANCE_SECRET:-}" -H 'content-type: application/json' \
              -X POST "$API/api/admin/maintenance/create-admin" --data "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"name\":\"Admin\"}" | sed -n '1,60p' || true
            echo '--- grant ADMIN role'
            curl -sS -H "x-maintenance-secret: ${MAINTENANCE_SECRET:-}" -H 'content-type: application/json' \
              -X POST "$API/api/admin/maintenance/grant-admin" --data "{\"email\":\"$EMAIL\"}" | sed -n '1,60p' || true
            echo '--- login and list users'
            curl -sS -c /tmp/cj -H 'content-type: application/json' -X POST "$API/api/admin/auth/login" \
              --data "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"remember\":true}" >/tmp/login.json || true
            curl -sS -b /tmp/cj "$API/api/admin/users/list?page=1&limit=10" | sed -n '1,120p' || true
      - name: Post-deploy verify registration page and no 0.0.0.0
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT }}
          timeout: 180s
          command_timeout: 30m
          script: |
            set -e
            echo '--- Verify registration page (200, allow redirects) ---'
            ok=0
            for i in $(seq 1 30); do
              code=$(curl -L -k -s -o /dev/null -w '%{http_code}' https://jeeey.com/register || true)
              echo "attempt $i => $code"
              case "$code" in 200|204|301|302|307|308) ok=1; break;; esac
              sleep 2
            done
            if [ "$ok" != "1" ]; then
              echo '--- Fallback: /register via --resolve to 127.0.0.1 ---'
              code=$(curl -L -k -s -o /dev/null -w '%{http_code}' --resolve jeeey.com:443:127.0.0.1 https://jeeey.com/register || true)
              echo "fallback => $code"
              case "$code" in 200|204|301|302|307|308) : ;; *) echo 'Registration page did not return 200/3xx (fallback)'; exit 1;; esac
            fi
            echo '--- Verify registration HTML has no 0.0.0.0 references ---'
            html=$(curl -L -k -s https://jeeey.com/register || true)
            if echo "$html" | grep -Eq "://0\.0\.0\.0|0\.0\.0\.0:"; then
              echo 'Registration HTML contains 0.0.0.0'; exit 1; fi
            echo '--- Grep built outputs for 0.0.0.0 (should be none) ---'
            if (grep -R -nE "://0\.0\.0\.0|0\.0\.0\.0:" /var/www/ecom/apps/web/.next 2>/dev/null || true) | head -n1 | grep -q "0.0.0.0"; then
              echo 'Found 0.0.0.0 in web build output'; exit 1; fi
            if (grep -R -nE "://0\.0\.0\.0|0\.0\.0\.0:" /var/www/ecom/apps/admin/.next 2>/dev/null || true) | head -n1 | grep -q "0.0.0.0"; then
              echo 'Found 0.0.0.0 in admin build output'; exit 1; fi

      - name: Post-deploy admin login end-to-end trace
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT || secrets.VPS_PORT || vars.VPS_PORT || 22 }}
          timeout: 240s
          command_timeout: 15m
          debug: true
          script_stop: true
          script: |
            set -Eeuxo pipefail
            EMAIL=${ADMIN_EMAIL:-admin@example.com}
            PASS=${ADMIN_PASSWORD:-admin123}
            CJ=/tmp/admin_login_$$.cookies
            rm -f "$CJ"
            echo '--- Admin login via API domain (JSON) ---'
            curl -k -sSi -c "$CJ" \
              -H 'content-type: application/json' \
              -X POST 'https://api.jeeey.com/api/admin/auth/login' \
              --data "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"remember\":true}" | sed -n '1,60p'
            echo
            echo '--- Extract token from response body (fallback to cookie if missing) ---'
            BODY=/tmp/admin_login_body_$$.json
            curl -k -s -c "$CJ" -H 'content-type: application/json' -X POST 'https://api.jeeey.com/api/admin/auth/login' --data "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"remember\":true}" -o "$BODY"
            TOKEN=$(grep -o '"token":"[^"]\+"' "$BODY" | head -n1 | sed 's/.*"token":"\([^"]\+\)".*/\1/') || true
            if [ -n "${TOKEN:-}" ]; then echo "token: ${#TOKEN} bytes"; else echo 'token: (not present, will rely on cookie)'; fi
            echo
            echo '--- Simulate bridge set-cookie and redirect chain ---'
            if [ -n "${TOKEN:-}" ]; then
              curl -k -sSI -b "$CJ" "https://admin.jeeey.com/bridge?token=${TOKEN}&remember=true&next=%2F" | sed -n '1,40p'
              # load home after bridge
              CODE=$(curl -k -s -o /dev/null -w '%{http_code}' -b "$CJ" https://admin.jeeey.com/ || true)
              echo "admin home after bridge => $CODE"
              [ "$CODE" = "200" ] || { echo 'Admin home did not return 200 after bridge'; exit 1; }
            else
              echo 'No token available; verifying whoami using cookie...'
              curl -k -sSI -b "$CJ" https://admin.jeeey.com/ | sed -n '1,20p'
            fi
            echo
            echo '--- API whoami (cookie jar) ---'
            curl -k -sS -b "$CJ" https://api.jeeey.com/api/admin/auth/whoami | sed -n '1,80p'
            echo
            echo '--- Done ---'

      - name: Admin pages and API smoke matrix (comprehensive)
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT || secrets.VPS_PORT || vars.VPS_PORT || 22 }}
          timeout: 240s
          command_timeout: 15m
          debug: true
          script_stop: true
          script: |
            set -Eeuxo pipefail
            EMAIL=${ADMIN_EMAIL:-${{ secrets.ADMIN_EMAIL || 'admin@example.com' }}}
            PASS=${ADMIN_PASSWORD:-${{ secrets.ADMIN_PASSWORD || 'admin123' }}}
            CJ=/tmp/admin_pages_$$.cookies
            rm -f "$CJ"
            echo '--- Login (JSON) ---'
            BODY=/tmp/login.body
            curl -k -s -c "$CJ" -o "$BODY" -H 'content-type: application/json' -X POST https://api.jeeey.com/api/admin/auth/login --data "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"remember\":true}"
            TOKEN=$(grep -o '"token":"[^"]\+"' "$BODY" | head -n1 | sed 's/.*"token":"\([^"]\+\)".*/\1/' ) || true
            echo "token-bytes: ${#TOKEN}"
            echo '--- Bridge cookie on admin domain ---'
            if [ -n "$TOKEN" ]; then curl -k -sSI -b "$CJ" "https://admin.jeeey.com/bridge?token=${TOKEN}&remember=true&next=%2F" | sed -n '1,30p' ; fi
            # Pages matrix
            echo '--- Admin pages matrix ---'
            pages=( "/" "/login" "/integrations" "/integrations/login" "/integrations/whatsapp-send" "/orders" "/products" "/categories" "/users" )
            for p in "${pages[@]}"; do
              code=$(curl -k -s -o /dev/null -w '%{http_code}' -b "$CJ" "https://admin.jeeey.com${p}" || true)
              echo "admin ${p} => ${code}"
              case "$code" in 200|204|301|302|307|308) : ;; *) echo "page failed: ${p}"; exit 1;; esac
            done
            # API matrix (read-only)
            echo '--- Admin API matrix (read-only) ---'
            # Categories list
            curl -k -sS 'https://api.jeeey.com/api/admin/categories?limit=1' -b "$CJ" | head -n1 | grep -q '{' || { echo 'categories API failed'; exit 1; }
            # Users list (if available)
            curl -k -sS 'https://api.jeeey.com/api/admin/users/list?page=1&limit=1' -b "$CJ" | head -n1 | grep -q '{' || echo 'users API not available (continuing)'
            echo '--- Matrix OK ---'

      - name: Post-deploy admin CRUD smoke (RBAC, grant-admin, users, vendor, user)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.allow_mutating_smokes == true }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT || secrets.VPS_PORT || vars.VPS_PORT || 22 }}
          timeout: 180s
          command_timeout: 60m
          script: |
            set -Eeuo pipefail
            EMAIL='${{ secrets.ADMIN_EMAIL || 'admin@example.com' }}'
            PASS='${{ secrets.ADMIN_PASSWORD || 'admin123' }}'
            SECRET='${{ secrets.MAINTENANCE_SECRET }}'
            if [ -z "$SECRET" ]; then echo 'MAINTENANCE_SECRET is empty'; exit 1; fi
            CJ=$(mktemp)
            echo '--- Login (JSON) ---'
            JSON=$(printf '{"email":"%s","password":"%s","remember":true}' "$EMAIL" "$PASS")
            CODE=$(curl -k -sS -w '%{http_code}' -o /tmp/login.body -c "$CJ" -H 'origin: https://admin.jeeey.com' -H 'content-type: application/json' -X POST https://api.jeeey.com/api/admin/auth/login --data "$JSON" || true)
            head -n 2 /tmp/login.body | sed -n '1,2p'
            [ "$CODE" = "200" ] || { echo "login failed: $CODE"; cat /tmp/login.body; exit 1; }
            echo '--- Ensure RBAC ---'
            RB=$(curl -k -sS -H "x-maintenance-secret: $SECRET" -X POST https://api.jeeey.com/api/admin/maintenance/ensure-rbac || true)
            echo "$RB" | sed -n '1,40p'
            echo '--- Grant admin ---'
            GA=$(curl -k -sS -H "x-maintenance-secret: $SECRET" -H 'content-type: application/json' -X POST https://api.jeeey.com/api/admin/maintenance/grant-admin --data "{\"email\":\"$EMAIL\"}" || true)
            echo "$GA" | sed -n '1,60p'
            echo '--- Users list (first 5) ---'
            UL=$(curl -k -sS -b "$CJ" 'https://api.jeeey.com/api/admin/users/list?page=1&limit=5' || true)
            echo "$UL" | sed -n '1,80p'
            echo '--- Create vendor (smoke) ---'
            VEND=$(curl -k -sS -b "$CJ" -H 'content-type: application/json' -X POST https://api.jeeey.com/api/admin/vendors --data '{"name":"Deploy Smoke Vendor"}' || true)
            echo "$VEND" | sed -n '1,80p'
            echo '--- Create user (smoke) ---'
            TS=$(date +%s)
            CUSR=$(curl -k -sS -b "$CJ" -H 'content-type: application/json' -X POST https://api.jeeey.com/api/admin/users --data "{\"email\":\"deploy+${TS}@local\",\"password\":\"Temp#12345\",\"name\":\"Deploy User\"}" || true)
            echo "$CUSR" | sed -n '1,120p'
            echo '--- CRUD smoke done ---'

      - name: Post-deploy admin categories smoke (create + list)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.allow_mutating_smokes == true }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT || secrets.VPS_PORT || vars.VPS_PORT || 22 }}
          timeout: 180s
          command_timeout: 30m
          script: |
            set -Eeuo pipefail
            EMAIL='${{ secrets.ADMIN_EMAIL || 'admin@example.com' }}'
            PASS='${{ secrets.ADMIN_PASSWORD || 'admin123' }}'
            SECRET='${{ secrets.MAINTENANCE_SECRET || vars.MAINTENANCE_SECRET }}'
            echo '--- Login to API (JSON, local first) ---'
            BODY=/tmp/login.body
            curl -sS -H 'content-type: application/json' -X POST http://127.0.0.1:4000/api/admin/auth/login --data "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"remember\":true}" -o "$BODY" || true
            if ! grep -q '"token":' "$BODY" 2>/dev/null; then
              echo 'Local login failed, trying public API...'
              curl -k -sS -H 'content-type: application/json' -X POST https://api.jeeey.com/api/admin/auth/login --data "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"remember\":true}" -o "$BODY"
            fi
            TOKEN=$(grep -o '"token":"[^"]\+"' "$BODY" | head -n1 | sed 's/.*"token":"\([^"]\+\)".*/\1/') || true
            if [ -z "$TOKEN" ]; then echo 'Missing token from login response'; head -n 40 "$BODY"; exit 1; fi
            if [ -n "$SECRET" ]; then
              echo '--- Ensure Category SEO columns (maintenance) ---'
              curl -sS -H "x-maintenance-secret: $SECRET" -X POST http://127.0.0.1:4000/api/admin/maintenance/ensure-category-seo -o /tmp/ens.body || true
              if ! grep -q 'ok' /tmp/ens.body 2>/dev/null; then
                echo 'Local ensure failed, trying public API...'
                curl -k -sS -H "x-maintenance-secret: $SECRET" -X POST https://api.jeeey.com/api/admin/maintenance/ensure-category-seo -o /tmp/ens.body || true
              fi
              head -n 1 /tmp/ens.body || true
            fi
            echo '--- Create category ---'
            TS=$(date +%s)
            BODY=$(printf '{"name":"SmokeCat %s","slug":"smoke-%s"}' "$TS" "$TS")
            CODE=$(curl -sS -w '%{http_code}' -o /tmp/cat.body -H 'content-type: application/json' -H "Authorization: Bearer $TOKEN" -X POST http://127.0.0.1:4000/api/admin/categories --data "$BODY" || true)
            if [ "$CODE" != "200" ]; then
              echo 'Local create failed, trying public API...'
              CODE=$(curl -k -sS -w '%{http_code}' -o /tmp/cat.body -H 'content-type: application/json' -H "Authorization: Bearer $TOKEN" -X POST https://api.jeeey.com/api/admin/categories --data "$BODY" || true)
            fi
            head -n 2 /tmp/cat.body | sed -n '1,2p'
            if [ "$CODE" != "200" ]; then echo "Category create failed: $CODE"; cat /tmp/cat.body; echo '=== API logs (tail) ==='; journalctl -u ecom-api --no-pager -n 120 || true; exit 1; fi
            echo '--- List categories (search=SmokeCat) ---'
            curl -sS -H "Authorization: Bearer $TOKEN" 'http://127.0.0.1:4000/api/admin/categories?search=SmokeCat' | sed -n '1,200p' || curl -k -sS -H "Authorization: Bearer $TOKEN" 'https://api.jeeey.com/api/admin/categories?search=SmokeCat' | sed -n '1,200p'

      - name: Server & Prisma comprehensive self-check
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT }}
          timeout: 240s
          command_timeout: 20m
          debug: true
          script_stop: true
          script: |
            set -e
            ROOT=${{ github.event.inputs.path || '/var/www/ecom' }}
            echo '== deploy info =='
            echo "commit=${GITHUB_SHA:-unknown} at $(date -u +%FT%TZ)" | tee "$ROOT/.deploy_info" || true
            echo '== api health =='
            curl -fsS http://127.0.0.1:4000/health || true; echo
            echo '== env vars (.env.api) =='
            if [ -f "$ROOT/.env.api" ]; then
              grep -E '^(DEFAULT_COUNTRY_CODE|WHATSAPP_(TOKEN|PHONE_ID|BUSINESS_ACCOUNT_ID|TEMPLATE|LANGUAGE)|WA_OTP_STRICT|OTP_SMS_WITH_WA|COOKIE_DOMAIN)=' "$ROOT/.env.api" || true
            else
              echo '(missing .env.api)'
            fi
            echo '== api process env (selected) =='
            pid=$(systemctl show -p MainPID ecom-api | cut -d= -f2)
            if [ -n "$pid" ] && [ -r "/proc/$pid/environ" ]; then
              tr '\0' '\n' </proc/$pid/environ | egrep '^(DEFAULT_COUNTRY_CODE|WHATSAPP_|WA_OTP_STRICT|OTP_SMS_WITH_WA|COOKIE_DOMAIN)=' || true
            else
              echo '(no pid or inaccessible /proc)'
            fi
            echo '== ports =='
            (command -v ss >/dev/null && ss -ltnp | egrep ':4000|:3001|:3000' || netstat -ltnp 2>/dev/null | egrep ':4000|:3001|:3000') || true
            echo '== dist checks =='
            if [ -d "$ROOT/packages/api/dist" ]; then
              echo '-- graph v15.0 references --'
              grep -R -n "graph.facebook.com/v15.0" "$ROOT/packages/api/dist" | head -n3 || echo '(none)'
              echo '-- WA_OTP_STRICT usage --'
              grep -R -n "WA_OTP_STRICT" "$ROOT/packages/api/dist" | head -n3 || echo '(none)'
              echo '-- deepseek default fallback (should be empty) --'
              MATCH=$(grep -R -nE "\|\|\s*['\"]فستان['\"]" "$ROOT/packages/api/dist" 2>/dev/null | head -n1 || true)
              if [ -n "$MATCH" ]; then echo "$MATCH"; else echo '(no default fallback found)'; fi
            else
              echo '(missing packages/api/dist)'
            fi
            echo '== prisma status =='
            if [ -f "$ROOT/.env.api" ]; then set -a; . "$ROOT/.env.api"; set +a; fi
            if [ -n "${DATABASE_URL:-}" ] || [ -n "${DIRECT_URL:-}" ]; then
              cd "$ROOT/packages/db"
              pnpm install --prod --ignore-scripts >/dev/null 2>&1 || true
              npx -y prisma@5.14.0 --version || true
              npx -y prisma@5.14.0 migrate status --schema "$ROOT/packages/db/prisma/schema.prisma" || true
              echo '== prisma introspect (columns snapshot) ==' || true
              if command -v psql >/dev/null 2>&1; then
                psql "$DATABASE_URL" -c "SELECT table_name, column_name, data_type FROM information_schema.columns WHERE table_schema='public' AND table_name IN ('NotificationLog','Category','DeliveryRate') ORDER BY table_name, ordinal_position;" || true
              fi
            else
              echo '(DATABASE_URL/DIRECT_URL not set)'
            fi
            echo '== NotificationLog tail (10) =='
            psql_ok=0
            if command -v psql >/dev/null 2>&1 && [ -n "${DATABASE_URL:-}" ]; then
              psql_ok=1
              psql "$DATABASE_URL" -c 'SELECT COALESCE("createdAt", createdat) as "createdAt",channel,target,title,status,COALESCE("messageId", messageid) as "messageId" FROM "NotificationLog" ORDER BY COALESCE("createdAt", createdat) DESC LIMIT 10;' || true
            else
              echo '(psql not available)'
            fi
            echo '== api logs (tail) =='
            journalctl -u ecom-api --no-pager -n 50 || tail -n 50 /var/log/ecom-api.out 2>/dev/null || true

      - name: Post-deploy admin categories delete smoke (create 3 → bulk-delete → verify)
        if: ${{ env.HAVE_SSH == '1' && ((github.event_name == 'workflow_dispatch' && inputs.allow_mutating_smokes == true) || github.event_name == 'push') }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT || secrets.VPS_PORT || vars.VPS_PORT || 22 }}
          timeout: 240s
          command_timeout: 15m
          debug: true
          script_stop: true
          script: |
            set -Eeuxo pipefail
            EMAIL='${{ secrets.ADMIN_EMAIL || 'admin@example.com' }}'
            PASS='${{ secrets.ADMIN_PASSWORD || 'admin123' }}'
            echo '--- Running delete smoke via Node (local filesystem) ---'
            cd /var/www/ecom
            node -e "process.env.ADMIN_EMAIL='${EMAIL}';process.env.ADMIN_PASSWORD='${PASS}';" scripts/ci/smoke-category-delete.mjs

      - name: External HTTPS smoke tests (retry)
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT || secrets.VPS_PORT || vars.VPS_PORT || 22 }}
          timeout: 240s
          command_timeout: 20m
          debug: true
          script_stop: true
          script: |
            set -ex
            doms=("https://jeeey.com" "https://admin.jeeey.com" "https://m.jeeey.com" "https://api.jeeey.com/health")
            for url in "${doms[@]}"; do
              echo "-- Smoke: $url"
              ok=0
              for i in $(seq 1 18); do
                code=$(curl -L -k -s -D /tmp/headers.txt -o /tmp/body.txt -w '%{http_code}' "$url" || true)
                if [ "$code" = "200" ] || [ "$code" = "204" ] || [ "$code" = "301" ] || [ "$code" = "302" ] || [ "$code" = "307" ] || [ "$code" = "308" ]; then ok=1; break; fi
                sleep 4
              done
              if [ "$ok" != "1" ]; then
                echo "Smoke failed for $url. Recent nginx errors:"
                journalctl -u nginx --no-pager -n 120 || true
                echo '--- Response headers ---'
                cat /tmp/headers.txt || true
                echo '--- Body (first 200 bytes) ---'
                head -c 200 /tmp/body.txt || true
                exit 1
              fi
            done

      - name: Admin layout check (UI sanity)
        if: ${{ env.HAVE_SSH == '1' }}
        env:
          ADMIN_BASE: ${{ secrets.ADMIN_BASE || 'https://admin.jeeey.com' }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
        run: |
          set -e
          cd scripts/ci
          npm i --no-fund --no-audit || true
          npx playwright install --with-deps chromium
          ADMIN_BASE="$ADMIN_BASE" ADMIN_EMAIL="$ADMIN_EMAIL" ADMIN_PASSWORD="$ADMIN_PASSWORD" node admin-layout-check.mjs

      - name: WhatsApp live smoke (strict template)
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        continue-on-error: true
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT }}
          timeout: 180s
          command_timeout: 10m
          debug: true
          script_stop: true
          script: |
            set -e
            API=${{ secrets.API_BASE || 'https://api.jeeey.com' }}
            PHONE='${{ secrets.WHATSAPP_TEST_PHONE || '' }}'
            TMPL='${{ secrets.WHATSAPP_TEMPLATE || 'otp_login_code' }}'
            if [ -z "$PHONE" ]; then echo 'WHATSAPP_TEST_PHONE not set; skipping WA smoke'; exit 0; fi
            EMAIL='${{ secrets.ADMIN_EMAIL || 'admin@example.com' }}'
            PASS='${{ secrets.ADMIN_PASSWORD || 'admin123' }}'
            curl -sS -c /tmp/cj -H 'content-type: application/json' -d "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"remember\":true}" -X POST "$API/api/admin/auth/login" >/dev/null
            # Use smart send which introspects template components
            resp=$(curl -sS -H 'content-type: application/json' -b /tmp/cj -X POST "$API/api/admin/whatsapp/send-smart" -d "{\"phone\":\"$PHONE\",\"template\":\"$TMPL\",\"languageCode\":\"ar\",\"bodyParams\":[\"123456\"]}")
            echo "Smart send => $(echo "$resp" | head -c 200)" || true
            echo "$resp" | grep -q 'messageId' || { echo "WA smoke failed: $resp"; exit 1; }
            mid=$(echo "$resp" | grep -o '"messageId":"[^\"]\+"' | head -n1 | sed 's/.*"messageId":"\([^\"]\+\)".*/\1/')
            for i in $(seq 1 5); do
              st=$(curl -sS -b /tmp/cj "$API/api/admin/whatsapp/status?id=$mid" || true)
              echo "$st" | grep -Eq 'DELIVERED|READ|SENT' && break
              sleep 3
            done

      - name: OTP request smoke (shop)
        if: ${{ env.HAVE_SSH == '1' }}
        uses: appleboy/ssh-action@v1.0.3
        continue-on-error: true
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT }}
          timeout: 120s
          command_timeout: 10m
          debug: true
          script_stop: true
          script: |
            set -e
            API=${{ secrets.API_BASE || 'https://api.jeeey.com' }}
            PHONE='${{ secrets.WHATSAPP_TEST_PHONE || '' }}'
            if [ -z "$PHONE" ]; then echo 'WHATSAPP_TEST_PHONE not set; skipping OTP smoke'; exit 0; fi
            echo '--- OTP request (whatsapp channel) ---'
            CODE=$(curl -s -o /tmp/otp.req -w '%{http_code}' -H 'content-type: application/json' -X POST "$API/api/auth/otp/request" --data "{\"phone\":\"$PHONE\",\"channel\":\"whatsapp\"}" || true)
            head -c 200 /tmp/otp.req || true; echo
            [ "$CODE" = "200" ] || { echo "OTP request failed: $CODE"; exit 1; }
            echo '--- OTP send log (last 10) ---'
            SECRET='${{ secrets.MAINTENANCE_SECRET || vars.MAINTENANCE_SECRET }}'
            if [ -n "$SECRET" ]; then
              curl -sS -H "x-maintenance-secret: $SECRET" "$API/api/auth/otp/send-log?phone=$PHONE" | head -c 400 || true; echo
              echo '--- Fetch latest OTP code (test endpoint) ---'
              OTP=$(curl -sS -H "x-maintenance-secret: $SECRET" "$API/api/test/otp/latest?phone=$PHONE" | sed -n 's/.*"code":"\([0-9]\+\)".*/\1/p' | head -n1)
              if [ -n "$OTP" ]; then
                echo "Using OTP=$OTP for verify smoke"
                echo '--- OTP verify (session) ---'
                V=$(curl -sS -o /tmp/otp.verify -w '%{http_code}' -H 'content-type: application/json' -X POST "$API/api/auth/otp/verify" --data "{\"phone\":\"$PHONE\",\"code\":\"$OTP\"}")
                echo "verify status: $V"; head -n1 /tmp/otp.verify || true
                echo '--- /api/me after verify ---'
                curl -sS "$API/api/me?ts=$(date +%s)" | head -c 200; echo
              else
                echo 'Could not fetch OTP via test endpoint; skipping verify.'
              fi
            else
              echo 'MAINTENANCE_SECRET not set; skipping send-log check.'
            fi

      - name: Post-deploy category delete proof (always)
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: ${{ env.SELECTED_SSH_PORT || env.SSH_PORT || secrets.VPS_PORT || vars.VPS_PORT || 22 }}
          timeout: 240s
          command_timeout: 15m
          debug: true
          script_stop: true
          script: |
            set -Eeuxo pipefail
            EMAIL='${{ secrets.ADMIN_EMAIL || 'admin@example.com' }}'
            PASS='${{ secrets.ADMIN_PASSWORD || 'admin123' }}'
            echo '--- Login (local API preferred) ---'
            BODY=/tmp/login.body
            curl -sS -H 'content-type: application/json' -X POST http://127.0.0.1:4000/api/admin/auth/login --data "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"remember\":true}" -o "$BODY" || true
            if ! grep -q '"token":' "$BODY" 2>/dev/null; then
              curl -k -sS -H 'content-type: application/json' -X POST https://api.jeeey.com/api/admin/auth/login --data "{\"email\":\"$EMAIL\",\"password\":\"$PASS\",\"remember\":true}" -o "$BODY" || true
            fi
            TOKEN=$(grep -o '"token":"[^"]\+"' "$BODY" | head -n1 | sed 's/.*"token":"\([^"]\+\)".*/\1/') || true
            [ -n "$TOKEN" ] || { echo 'Login failed: missing token'; head -n 40 "$BODY"; exit 1; }
            echo '--- Create temp category ---'
            TS=$(date +%s)
            DATA=$(printf '{"name":"DelProbe %s","slug":"delprobe-%s"}' "$TS" "$TS")
            CODE=$(curl -sS -w '%{http_code}' -o /tmp/cat.create -H 'content-type: application/json' -H "Authorization: Bearer $TOKEN" -X POST http://127.0.0.1:4000/api/admin/categories --data "$DATA" || true)
            if [ "$CODE" != "200" ]; then
              CODE=$(curl -k -sS -w '%{http_code}' -o /tmp/cat.create -H 'content-type: application/json' -H "Authorization: Bearer $TOKEN" -X POST https://api.jeeey.com/api/admin/categories --data "$DATA" || true)
            fi
            [ "$CODE" = "200" ] || { echo "Create failed: $CODE"; cat /tmp/cat.create; exit 1; }
            ID=$(grep -o '"id":"[^"]\+"' /tmp/cat.create | head -n1 | sed 's/.*"id":"\([^"]\+\)".*/\1/') || true
            [ -n "$ID" ] || { echo 'Create missing id'; cat /tmp/cat.create; exit 1; }
            echo "created: $ID"
            echo '--- Bulk delete temp category ---'
            PAY=$(printf '{"ids":["%s"]}' "$ID")
            CODE=$(curl -sS -w '%{http_code}' -o /tmp/cat.del -H 'content-type: application/json' -H "Authorization: Bearer $TOKEN" -X POST http://127.0.0.1:4000/api/admin/categories/bulk-delete --data "$PAY" || true)
            if [ "$CODE" != "200" ]; then
              CODE=$(curl -k -sS -w '%{http_code}' -o /tmp/cat.del -H 'content-type: application/json' -H "Authorization: Bearer $TOKEN" -X POST https://api.jeeey.com/api/admin/categories/bulk-delete --data "$PAY" || true)
            fi
            [ "$CODE" = "200" ] || { echo "Delete failed: $CODE"; cat /tmp/cat.del; exit 1; }
            if ! grep -q '"deleted":' /tmp/cat.del; then echo 'Missing deleted count in response'; cat /tmp/cat.del; exit 1; fi
            echo '--- Verify not found by search ---'
            OUT=$(curl -sS -H "Authorization: Bearer $TOKEN" "http://127.0.0.1:4000/api/admin/categories?search=$ID" || curl -k -sS -H "Authorization: Bearer $TOKEN" "https://api.jeeey.com/api/admin/categories?search=$ID" || true)
            echo "$OUT" | grep -q '"categories"' || { echo 'List response malformed'; echo "$OUT"; exit 1; }
            if echo "$OUT" | grep -q "$ID"; then echo 'Category still appears in list after deletion'; echo "$OUT"; exit 1; fi
            echo 'Category delete proof OK'

      - name: Admin console production smoke (pages + login)
        env:
          ADMIN_URL: https://admin.jeeey.com
          API_URL: https://api.jeeey.com
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL || 'admin@example.com' }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD || 'admin123' }}
        run: |
          set -e
          node scripts/ci/admin-console-prod-smoke.mjs || { echo 'Prod admin smoke failed'; exit 1; }

      - name: Print service logs (admin & web)
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST || vars.VPS_HOST || env.SSH_HOST }}
          username: ${{ env.SSH_USER }}
          key_path: ${{ env.SSH_KEY_PATH }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          password: ${{ secrets.SSH_PASSWORD }}
          timeout: 180s
          command_timeout: 20m
          script: |
            set -e
            echo '=== ecom-admin logs (tail) ==='
            journalctl -u ecom-admin --no-pager -n 200 || true
            echo '=== ecom-web logs (tail) ==='
            journalctl -u ecom-web --no-pager -n 200 || true
        continue-on-error: true