name: CI / CD (pnpm & Turborepo)

on:
  push:
    branches:
      - main
      - 'feature/**'
  pull_request:
    branches:
      - main

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  actions: read
  security-events: write

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8.6.10'

jobs:
  build_and_test:
    name: Build / Lint / Test / Build (monorepo)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Enable corepack & prepare pnpm
        run: |
          corepack enable
          corepack prepare pnpm@${{ env.PNPM_VERSION }} --activate
          pnpm -v

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: |
            ~/.pnpm-store
            ~/.local/share/pnpm
            ~/.cache/pnpm
          key: pnpm-store-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-store-${{ runner.os }}-

      - name: Install dependencies (workspace)
        run: pnpm install --frozen-lockfile

      - name: Lint (workspace)
        run: pnpm -w -s lint

      - name: Run unit tests (workspace)
        run: pnpm -w -s test

      - name: Build (workspace / turborepo-aware)
        run: pnpm -w -s build

      - name: Upload build artifacts (optional)
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            apps/web/.next || true
            apps/mobile/.expo || true
            dist || ./**/dist || true

  security_scan_codeql:
    name: CodeQL Security Scan
    runs-on: ubuntu-latest
    needs: build_and_test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript, typescript

      - name: Perform CodeQL analysis
        uses: github/codeql-action/analyze@v2

  dependency_audit:
    name: Dependency Audit (pnpm)
    runs-on: ubuntu-latest
    needs: build_and_test
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js & enable pnpm
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      - name: Enable corepack & prepare pnpm
        run: |
          corepack enable
          corepack prepare pnpm@${{ env.PNPM_VERSION }} --activate
          pnpm -v

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run dependency audit (pnpm audit)
        run: |
          pnpm audit --json > pnpm-audit.json || true
          cat pnpm-audit.json

      - name: Upload audit result
        uses: actions/upload-artifact@v4
        with:
          name: pnpm-audit
          path: pnpm-audit.json

  deploy_staging:
    name: Deploy to Staging (SSH)
    runs-on: ubuntu-latest
    needs: [build_and_test, security_scan_codeql, dependency_audit]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: staging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js & enable pnpm
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Enable corepack & prepare pnpm
        run: |
          corepack enable
          corepack prepare pnpm@${{ env.PNPM_VERSION }} --activate
          pnpm -v

      - name: Install dependencies (workspace)
        run: pnpm install --frozen-lockfile

      - name: Build web for deploy (filter to web to save time)
        run: pnpm -w --filter ./apps/web... build

      - name: Create archive of web build (optional)
        run: |
          if [ -d "apps/web/.next" ]; then
            tar -czf web-build-${{ github.sha }}.tar.gz -C apps/web .next
            ls -lah web-build-*.tar.gz
          fi

      - name: Deploy to staging server via SSH (execute remote deploy script)
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.STAGING_HOST }}
          username: ${{ secrets.STAGING_USER }}
          key: ${{ secrets.STAGING_SSH_KEY }}
          port: ${{ secrets.STAGING_SSH_PORT || '22' }}
          script: |
            set -e
            echo "Preparing staging directory: ${{ secrets.STAGING_APP_PATH }}"
            mkdir -p "${{ secrets.STAGING_APP_PATH }}"
            if [ -f "${{ secrets.STAGING_APP_PATH }}/deploy.sh" ]; then
              echo "Executing remote deploy.sh"
              cd "${{ secrets.STAGING_APP_PATH }}" || exit 1
              ./deploy.sh ${{ github.sha }}
            else
              echo "No deploy.sh found on server. Please implement deploy steps on server."
            fi
            echo "Staging deploy finished."

      - name: Upload deployed archive artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: web-build-archive
          path: web-build-${{ github.sha }}.tar.gz || true

  smoke_test_staging:
    name: Smoke Tests on Staging
    runs-on: ubuntu-latest
    needs: deploy_staging
    if: needs.deploy_staging.result == 'success'
    steps:
      - name: Ensure STAGING_URL secret exists
        run: |
          if [ -z "${{ secrets.STAGING_URL }}" ]; then
            echo "STAGING_URL secret is empty or not set. Skipping smoke tests."
            exit 0
          fi

      - name: Basic health check (root)
        run: |
          echo "Checking ${STAGING_URL}"
          curl -I --max-time 20 "${{ secrets.STAGING_URL }}" | sed -n '1,20p'

      - name: Check /api/health (if exists)
        run: |
          HEALTH_URL="${{ secrets.STAGING_URL%/ }}/api/health"
          echo "Checking $HEALTH_URL"
          curl -sSf "$HEALTH_URL" || (echo "Health endpoint failed" && exit 1)

      - name: Sample product page check
        run: |
          PRODUCTS_URL="${{ secrets.STAGING_URL%/ }}/products"
          echo "Checking $PRODUCTS_URL"
          curl -s --fail "$PRODUCTS_URL" -o /tmp/products.html
          wc -c /tmp/products.html

  final_notifications:
    name: Final Notifications
    runs-on: ubuntu-latest
    needs: [build_and_test, security_scan_codeql, dependency_audit, deploy_staging, smoke_test_staging]
    steps:
      - name: Summary message (to console)
        run: |
          echo "CI pipeline finished. Results:"
          echo " - build_and_test: ${{ needs.build_and_test.result }}"
          echo " - codeql: ${{ needs.security_scan_codeql.result }}"
          echo " - audit: ${{ needs.dependency_audit.result }}"
          echo " - deploy_staging: ${{ needs.deploy_staging.result }}"
          echo " - smoke_test_staging: ${{ needs.smoke_test_staging.result || 'skipped' }}"

      - name: Slack summary (optional)
        if: always() && secrets.SLACK_WEBHOOK
        run: |
          STATUS="CI pipeline finished for commit ${{ github.sha }} on repo ${{ github.repository }}"
          payload="{\"text\":\"${STATUS}\"}"
          curl -s -X POST -H 'Content-type: application/json' --data "$payload" "${{ secrets.SLACK_WEBHOOK }}"
