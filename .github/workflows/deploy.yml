name: Deploy to VPS

on:
  push:
    branches: [ main ]

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 8.15.4

      - name: Sync repository to VPS (/var/www/ecom)
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/var/www/ecom"
          overwrite: true
          rm: true
          strip_components: 0
          timeout: 120s
          proxy_port: 0

      - name: Remote deploy
        uses: appleboy/ssh-action@v1.0.3
        env:
          PROJECT_DIR: /var/www/ecom
          NODE_ENV: production
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL }}
          NEXT_PUBLIC_ADMIN_URL: ${{ secrets.NEXT_PUBLIC_ADMIN_URL }}
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
          VITE_API_BASE: ${{ secrets.VITE_API_BASE }}
          COOKIE_DOMAIN: ${{ secrets.COOKIE_DOMAIN }}
          CORS_ALLOW_ORIGINS: ${{ secrets.CORS_ALLOW_ORIGINS }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
          EXPO_PUBLIC_TRPC_URL: ${{ secrets.EXPO_PUBLIC_TRPC_URL }}
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          MAINTENANCE_SECRET: ${{ secrets.MAINTENANCE_SECRET }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: PROJECT_DIR,NODE_ENV,NEXT_PUBLIC_APP_URL,NEXT_PUBLIC_ADMIN_URL,NEXT_PUBLIC_API_BASE_URL,VITE_API_BASE,COOKIE_DOMAIN,CORS_ALLOW_ORIGINS,DATABASE_URL,DIRECT_URL,EXPO_PUBLIC_TRPC_URL,EXPO_TOKEN,JWT_SECRET,MAINTENANCE_SECRET
          script: |
            set -euo pipefail
            echo "[deploy] Using PROJECT_DIR=$PROJECT_DIR"
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            bash infra/deploy/remote-deploy.sh
