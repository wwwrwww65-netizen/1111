name: Deploy to VPS

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy and verify on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 60s
          command_timeout: 30m
          script_stop: true
          script: |
            set -euo pipefail

            # Config from secrets with safe defaults
            API_BASE=${{ secrets.API_BASE }}
            [ -z "${API_BASE:-}" ] && API_BASE="https://api.jeeey.com"
            ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
            ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
            MAINTENANCE_SECRET=${{ secrets.MAINTENANCE_SECRET }}

            command -v jq >/dev/null || { sudo apt-get update -y && sudo apt-get install -y jq; }

            COOKIE_JAR="$(mktemp)"; trap 'rm -f "$COOKIE_JAR"' EXIT
            say(){ printf "\n==> %s\n" "$*"; }
            is_json(){ jq -e . >/dev/null 2>&1; }
            require(){ echo "$1" | jq -e "$2" >/dev/null || { echo "[FAIL] $3"; exit 1; }; }
            ccurl(){ curl -skS -b "$COOKIE_JAR" -H "X-Maintenance-Secret: $MAINTENANCE_SECRET" "$@"; }

            say "Login (admin)"
            LOGIN_OK=false
            for URL in \
              "$API_BASE/api/admin/auth/login" \
              "$API_BASE/api/auth/login" \
              "$API_BASE/api/login"; do
              if curl -skS -c "$COOKIE_JAR" -H 'content-type: application/json' -X POST "$URL" \
                   --data "{\"email\":\"$ADMIN_EMAIL\",\"password\":\"$ADMIN_PASSWORD\"}" \
                   | jq -e '.success==true or .token or .user.id' >/dev/null 2>&1; then
                LOGIN_OK=true; break
              fi
            done
            $LOGIN_OK || { echo "[FAIL] login failed"; exit 1; }

            # Warehouse: sorting orders
            say "sorting/orders"
            SORTING_JSON="$(ccurl "$API_BASE/api/admin/logistics/warehouse/sorting/orders")"
            echo "$SORTING_JSON" | is_json || { echo "$SORTING_JSON" | head -n1; echo "[FAIL] sorting/orders not JSON"; exit 1; }
            require "$SORTING_JSON" '.orders|type=="array"' 'orders[]'

            OID="$(echo "$SORTING_JSON" | jq -r '.orders[0].orderId // empty')"
            if [ -n "$OID" ]; then
              say "sorting/items?orderId=$OID"
              ITEMS_JSON="$(ccurl "$API_BASE/api/admin/logistics/warehouse/sorting/items?orderId=$OID")"
              echo "$ITEMS_JSON" | is_json || { echo "$ITEMS_JSON" | head -n1; echo "[FAIL] sorting/items not JSON"; exit 1; }
              require "$ITEMS_JSON" '.items|type=="array"' 'sorting items[]'
              echo "$ITEMS_JSON" | jq -e '.items|length==0 or (.items[0] | has("status") and has("receivedAt") and (has("result") or true))' >/dev/null \
                || { echo "[FAIL] missing fields in sorting/items"; exit 1; }
            fi

            # Warehouse: ready orders
            say "ready/orders"
            READY_JSON="$(ccurl "$API_BASE/api/admin/logistics/warehouse/ready/orders")"
            echo "$READY_JSON" | is_json || { echo "$READY_JSON" | head -n1; echo "[FAIL] ready/orders not JSON"; exit 1; }
            require "$READY_JSON" '.orders|type=="array"' 'ready orders[]'
            echo "$READY_JSON" | jq -e '.orders|length==0 or (.orders[0] | has("recipient") and has("phone") and has("state") and has("city") and has("street") and (has("paymentDisplay") or has("paymentMethod")) and (has("shippingTitle") or has("shipping")) and has("total"))' >/dev/null \
              || { echo "[FAIL] missing fields in ready/orders"; exit 1; }

            # Delivery: in delivery
            say "delivery/list?tab=in_delivery"
            IN_DEL="$(ccurl "$API_BASE/api/admin/logistics/delivery/list?tab=in_delivery")"
            echo "$IN_DEL" | is_json || { echo "$IN_DEL" | head -n1; echo "[FAIL] in_delivery not JSON"; exit 1; }
            require "$IN_DEL" '.items|type=="array"' 'in_delivery items[]'

            # Delivery: completed
            say "delivery/list?tab=completed"
            DONE="$(ccurl "$API_BASE/api/admin/logistics/delivery/list?tab=completed")"
            echo "$DONE" | is_json || { echo "$DONE" | head -n1; echo "[FAIL] completed not JSON"; exit 1; }
            require "$DONE" '.items|type=="array"' 'completed items[]'

            echo "[OK] Deploy verification passed"

