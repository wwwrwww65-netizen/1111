name: deploy_vps

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: deploy_vps-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: |
            ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Prime known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 72.60.92.17 >> ~/.ssh/known_hosts 2>/dev/null

      - name: Rsync repository to VPS (/var/www/ecom)
        run: |
          rsync -az --delete \
            --exclude=.git \
            --exclude=node_modules \
            --exclude=.next \
            --exclude=dist \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ root@72.60.92.17:/var/www/ecom

      - name: Build and restart services on VPS
        run: |
          ssh -o StrictHostKeyChecking=no root@72.60.92.17 'bash -lc '\''
            set -e
            export PRISMA_IGNORE_ENV_CONFLICT=1
            export NEXT_CACHE_DISABLED=1
            export TURBO_FORCE=1
            export PATH="/usr/local/bin:/usr/bin:$PATH"
            cd /var/www/ecom
            corepack enable || true
            corepack prepare pnpm@9.15.9 --activate || corepack prepare pnpm@9 --activate || true
            pnpm -v || npm i -g pnpm@9
            # Install deps (include dev for builds)
            CI=1 NODE_ENV=development pnpm install --frozen-lockfile=false --prod=false --force | cat
            # Build packages
            export NODE_ENV=production
            pnpm --filter @repo/db build | cat
            rm -rf apps/admin/.next apps/web/.next || true
            pnpm --filter admin build | cat
            pnpm --filter web build | cat
            pnpm --filter @repo/api build | cat
            # Prepare standalone
            if [ -d apps/admin/.next/standalone ]; then cp -r apps/admin/public apps/admin/.next/standalone/ 2>/dev/null || true; fi
            if [ -d apps/web/.next/standalone ]; then cp -r apps/web/public apps/web/.next/standalone/ 2>/dev/null || true; fi
            # Update systemd units
            install -m 0644 -T infra/systemd/ecom-admin.service /etc/systemd/system/ecom-admin.service
            install -m 0644 -T infra/systemd/ecom-api.service /etc/systemd/system/ecom-api.service
            systemctl daemon-reload
            systemctl restart ecom-api || true
            systemctl restart ecom-admin || true
            # Nginx canonical HTTP->HTTPS redirects
            install -m 0644 -T infra/deploy/nginx/jeeey.conf /etc/nginx/sites-available/jeeey.conf
            ln -sf /etc/nginx/sites-available/jeeey.conf /etc/nginx/sites-enabled/jeeey.conf
            rm -f /etc/nginx/sites-enabled/default /etc/nginx/conf.d/default.conf || true
            nginx -t
            systemctl reload nginx
          '\'''

      - name: Verify deployment (services, ports, endpoints)
        run: |
          ssh -o StrictHostKeyChecking=no root@72.60.92.17 'bash -lc '\''
            set -e
            echo "=== services ==="; systemctl is-active ecom-api ecom-admin nginx || true
            echo "=== ports ==="; ss -ltnp 2>/dev/null | egrep ":80 |:443 |:3000 |:3001 |:4000 " || true
            echo "=== nginx conflicts (should be empty warnings) ==="; nginx -T 2>/dev/null | grep -En "server_name\s+.*jeeey\.com" | sed -n '1,200p' || true
            echo "=== admin HEAD / (expect 200/307) ==="; curl -s -I https://admin.jeeey.com | sed -n '1,15p'
            echo "=== api health ==="; curl -s -i https://api.jeeey.com/health | sed -n '1,15p'
            echo "=== login attempt to API (may 200/401) ==="; curl -s -i -X POST -H 'content-type: application/json' --data '{"email":"admin@example.com","password":"admin123"}' https://api.jeeey.com/api/admin/auth/login | sed -n '1,20p'
          '\'''

      - name: Upload deployment logs (debug)
        if: always()
        run: |
          echo "No local logs; remote checks printed above."

