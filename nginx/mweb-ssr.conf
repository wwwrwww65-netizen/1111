# SSR Configuration for mweb system pages
# This file should be included in the main nginx config for m.jeeey.com server block

# SSR for system pages - route bots to Backend API, regular users to Next.js
location ~ ^/(categories|products|cart|search|account|wishlist|checkout)$ {
  # Check if request is from a bot
  if ($http_user_agent ~* "(facebookexternalhit|WhatsApp|Twitterbot|LinkedInBot|TelegramBot|Slackbot|Discordbot|Google-InspectionTool|Googlebot|bingbot|Baiduspider|YandexBot|DuckDuckBot)") {
    # Proxy to Backend API for SSR
    rewrite ^ /ssr-backend$uri last;
  }
  
  # Regular users: proxy to Next.js
  proxy_pass http://127.0.0.1:3000;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
}

# Internal location for bot SSR (Backend API)
location ~ ^/ssr-backend(/.*)$ {
  internal;
  proxy_pass http://127.0.0.1:4000$1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_http_version 1.1;
}
