# SSR Configuration for mweb system pages
# This file should be included in the main nginx config for m.jeeey.com server block
# Add this BEFORE the location ~ ^/(p|product|c|category)/ block

# Map to determine upstream based on User-Agent (bot detection)
map $http_user_agent $mweb_upstream {
  default "http://127.0.0.1:3000";  # Regular users -> Next.js
  ~*(facebookexternalhit|WhatsApp|Twitterbot|LinkedInBot|TelegramBot|Slackbot|Discordbot|Google-InspectionTool|Googlebot|bingbot|Baiduspider|YandexBot|DuckDuckBot) "http://127.0.0.1:4000";  # Bots -> Backend API for SSR
}

# SSR for system pages (categories, products, cart, etc.) - for social sharing
location ~ ^/(categories|products|cart|search|account|wishlist|checkout)$ {
  # Proxy to the appropriate upstream (Next.js or Backend API)
  proxy_pass $mweb_upstream;
  
  # Standard proxy headers
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto https;
  proxy_http_version 1.1;
  
  # WebSocket support (for Next.js HMR)
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";
}
